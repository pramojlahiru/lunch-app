<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Your Meal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow-lg">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <img src="https://cdn-icons-png.flaticon.com/512/3075/3075977.png" 
                         class="h-8 w-8">
                    <span class="text-xl font-bold text-gray-800">Lunch App</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-600">Hi, <%= user.username %></span>
                    <a href="/logout" 
                       class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 
                              transition-all shadow-md">
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto py-12 px-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 hover-scale">
            <h2 class="text-2xl font-bold text-gray-800 mb-8">Select Your Meal</h2>
            
            <form action="/preference" method="post" id="preference-form">
                <!-- Date Picker -->
                <div class="mb-8">
                    <label class="block text-gray-700 text-sm font-semibold mb-2">Select Date</label>
                    <input type="date" id="datePicker" name="date" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                           required>
                </div>

                <!-- Meal Options -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Vegetarian Card -->
                    <label class="cursor-pointer">
                        <input type="radio" name="preference" value="veg" 
                               class="hidden peer">
                        <div class="p-6 border-2 rounded-2xl peer-checked:border-green-500 
                                  peer-checked:bg-green-50 hover:border-green-300 transition-all h-full">
                            <div class="text-center">
                                <img src="https://cdn-icons-png.flaticon.com/512/1046/1046784.png" 
                                     class="w-16 h-16 mx-auto mb-4 animate-pulse">
                                <h3 class="text-xl font-semibold mb-2">Vegetarian</h3>
                                <p class="text-gray-600 text-sm">Fresh plant-based meals</p>
                            </div>
                        </div>
                    </label>

                    <!-- Chicken Card -->
                    <label class="cursor-pointer">
                        <input type="radio" name="preference" value="chicken" 
                               class="hidden peer">
                        <div class="p-6 border-2 rounded-2xl peer-checked:border-orange-500 
                                  peer-checked:bg-orange-50 hover:border-orange-300 transition-all h-full">
                            <div class="text-center">
                                <img src="https://cdn-icons-png.flaticon.com/512/1046/1046771.png" 
                                     class="w-16 h-16 mx-auto mb-4 animate-pulse">
                                <h3 class="text-xl font-semibold mb-2">Chicken</h3>
                                <p class="text-gray-600 text-sm">Grilled poultry dishes</p>
                            </div>
                        </div>
                    </label>

                    <!-- Fish Card -->
                    <label class="cursor-pointer">
                        <input type="radio" name="preference" value="fish" 
                               class="hidden peer">
                        <div class="p-6 border-2 rounded-2xl peer-checked:border-blue-500 
                                  peer-checked:bg-blue-50 hover:border-blue-300 transition-all h-full">
                            <div class="text-center">
                                <img src="https://cdn-icons-png.flaticon.com/512/1046/1046769.png" 
                                     class="w-16 h-16 mx-auto mb-4 animate-pulse">
                                <h3 class="text-xl font-semibold mb-2">Fish</h3>
                                <p class="text-gray-600 text-sm">Fresh seafood selection</p>
                            </div>
                        </div>
                    </label>
                </div>

                <div class="mt-8 text-center">
                    <button type="submit" 
                            class="bg-blue-600 text-white px-8 py-3 rounded-xl hover:bg-blue-700 
                                   transition-all shadow-lg relative" id="submit-btn">
                        <span class="when-enabled">Save Selection</span>
                        <span class="when-loading hidden">
                            <svg class="animate-spin h-5 w-5 text-white mx-auto" 
                                 xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <% if (success) { %>
        <div class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-xl 
                    animate-fade-in flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span>Preference saved successfully!</span>
        </div>
    <% } %>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const datePicker = document.getElementById('datePicker');
            const preferences = <%- JSON.stringify(preferences) %>;

            // IST time calculation
            const now = new Date();
            const istOffset = 330; // minutes
            const istTime = new Date(now.getTime() + (istOffset - now.getTimezoneOffset()) * 60000);
            
            // Date constraints
            const today = new Date(istTime);
            today.setHours(0,0,0,0);
            
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const dayAfter = new Date(today);
            dayAfter.setDate(dayAfter.getDate() + 2);

            // Set min/max dates
            let minDate = today;
            if (istTime.getHours() >= 10) { // After 10 AM IST
                minDate = tomorrow;
            }
            
            datePicker.min = formatDate(minDate);
            datePicker.max = formatDate(dayAfter);

            // Disable weekends
            datePicker.addEventListener('input', function() {
                const selectedDate = new Date(this.value);
                const day = selectedDate.getDay();
                
                if (day === 0 || day === 6) {
                    this.setCustomValidity('Weekends are not allowed');
                } else {
                    this.setCustomValidity('');
                }
            });

            // Preselect existing preference
            datePicker.addEventListener('change', function() {
                const selectedDate = this.value;
                const preference = preferences[selectedDate];
                if (preference) {
                    document.querySelector(`input[value="${preference}"]`).checked = true;
                }
            });

            function formatDate(date) {
                return date.toISOString().split('T')[0];
            }
        });

        document.getElementById('preference-form').addEventListener('submit', () => {
            const btn = document.getElementById('submit-btn');
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            btn.querySelector('.when-enabled').classList.add('hidden');
            btn.querySelector('.when-loading').classList.remove('hidden');
        });
    </script>
</body>
</html>